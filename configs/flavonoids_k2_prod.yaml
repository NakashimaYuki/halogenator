# ==============================================================================
# Production Configuration: CNPD-ETCM Halogenated Flavonoid Library (k≤2)
# ==============================================================================
#
# Purpose: Generate comprehensive halogenated flavonoid library from ETCM database
#
# Key Features:
# - k_max: 2 (up to double substitution)
# - Deduplication: ENABLED (clean library, no structural duplicates)
# - Sugar mask: ENABLED (heuristic mode, protects glycosidic groups)
# - R2 (prenylation): ENABLED with fallback for broader coverage
# - R6_methyl: ENABLED (both step and macro modes)
# - Output: FLAT structure (single products_k2.parquet, no hierarchical SDF)
# - All 4 halogens: F, Cl, Br, I
#
# ==============================================================================

subset: cnpd_etcm_flavonoids
k_max: 2

# Halogen selection (all standard halogens)
halogens:
  - F
  - Cl
  - Br
  - I

# Rule selection
# R1: Aromatic C-H halogenation
# R2: Prenylation (allylic C-H)
# R3: Hydroxyl O-halogenation
# R6_methyl: Methyl halogenation (step: -CH3 → -CH2X, macro: -CF3/-CCl3)
rules:
  - R1
  - R2
  - R3
  - R6_methyl

# ==============================================================================
# Engine Configuration
# ==============================================================================
engine_cfg:
  budget_mode: ops  # Count by operations; k_atoms will be derived from atom_cost
  rdkit_threads: 8  # Adjust based on machine CPU cores (4-16 typical)

# ==============================================================================
# Deduplication (ENABLED)
# ==============================================================================
# Remove structural duplicates (same InChI key) to produce clean library
dedup:
  enable: true

# ==============================================================================
# Sugar Mask (ENABLED)
# ==============================================================================
# Protect glycosidic groups and anomeric positions from halogenation
# Mode: heuristic (detects common sugar patterns without template matching)
sugar_cfg:
  mode: heuristic

# ==============================================================================
# Constraints (ENABLED)
# ==============================================================================
# Apply chemical feasibility constraints to avoid unrealistic structures
constraints:
  enable: true

# ==============================================================================
# Rule-Specific Configuration
# ==============================================================================
rules_cfg:
  # R2: Prenylation (allylic C-H halogenation)
  r2:
    enable: true
    fallback: true  # Enable fallback mode for broader coverage beyond strict allylic positions

  # R6_methyl: Methyl halogenation
  r6_methyl:
    enable_step: true      # Step halogenation: -CH3 → -CH2X
    enable_macro: true     # Macro substitution: -CF3, -CCl3
    allow_on_methoxy: true # Allow halogenation on -OCH3 groups (common in flavonoids)

    # Symmetry folding for equivalent methyls (optional)
    # Set to false to enumerate all equivalent sites separately (raw mode)
    # Set to true to fold equivalent methyls into single representative (reduces redundancy)
    # fold_equivalent_methyl_on_same_carbon: false

# ==============================================================================
# Output Configuration
# ==============================================================================
output:
  structure: flat  # FLAT structure: single products_k2.parquet (NO hierarchical SDF)

  # CSV statistics by rule family (recommended)
  by_rule_csv: true

  # Parquet output (primary format)
  parquet: true

  # Explicitly disable hierarchical output (if supported)
  # hierarchical: false

# ==============================================================================
# QA and Reporting
# ==============================================================================
qa:
  summary: true  # Generate QA summary with field consistency checks

# ==============================================================================
# Performance Tuning Notes
# ==============================================================================
#
# For large-scale production runs:
#
# 1. RDKit threads:
#    - Set to number of physical CPU cores (not hyperthreads)
#    - If running multiple shards in parallel, reduce to avoid oversubscription
#    - Example: 8-core machine running 4 parallel shards → rdkit_threads: 2
#
# 2. Memory management:
#    - Larger molecules (flavonoids with sugars) consume more memory
#    - Monitor memory usage and adjust shard size if needed
#    - Typical: 2-4 GB per shard enumeration process
#
# 3. Deduplication overhead:
#    - InChI generation adds ~10-20% overhead but ensures clean library
#    - Worth the cost for production-quality database
#
# 4. Sugar mask performance:
#    - Heuristic mode is fast (minimal overhead)
#    - Template mode (if available) is slower but more accurate
#
# ==============================================================================
