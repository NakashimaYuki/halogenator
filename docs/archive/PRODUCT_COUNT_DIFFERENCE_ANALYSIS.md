# Flavone-2X-OMe vs Flavone-2X-NH2 产物数量差异深度分析

**调查时间**: 2025-11-12
**调查人**: Claude Code

---

## 问题描述

用户观察到两个派生库的产物数量存在显著差异：
- **Flavone-2X-OMe**: 25,701,490 个唯一产物
- **Flavone-2X-NH2**: 19,114,964 个唯一产物
- **差异**: 6,586,526 个产物 (+34.5%)

同时，两组使用相同的base库（Flavone-2X, 4,861,369个分子），但products.parquet中实际处理的source分子数却不同：
- **OMe组**: 4,447,334 个unique source
- **NH2组**: 3,987,440 个unique source
- **缺失**: 都未达到base库的4.86M

---

## 调查发现

### 1. 反应层面的差异

从SUMMARY.json统计：

| 指标 | OMe组 | NH2组 | 差异 |
|------|-------|-------|------|
| total_input | 4,861,369 | 4,861,369 | 0 |
| fail_no_matching_sites | 376,534 | 373,739 | -2,795 |
| total_processed (反应产物总数) | 26,984,387 | 20,023,649 | +6,960,738 (+34.8%) |
| unique_products (去重后) | 25,701,490 | 19,114,964 | +6,586,526 (+34.5%) |

**关键发现**: 差异在反应层面就已经存在（去重前就相差34.8%），不是去重导致的。

### 2. Source分子缺失分析

从base库角度：

| 分类 | 分子数 | 占比 |
|------|--------|------|
| 两组都成功 | 3,950,129 | 81.3% |
| OMe成功但NH2失败 | **497,205** | **10.2%** |
| NH2成功但OMe失败 | 37,311 | 0.8% |
| 两组都失败 | 376,724 | 7.7% |
| **总计** | **4,861,369** | **100%** |

**关键发现**: 有约50万个分子在OMe组成功，但在NH2组失败或产物被完全去重！

### 3. 去重导致的Source缺失

| 指标 | OMe组 | NH2组 |
|------|-------|-------|
| 期望成功数 (减去fail_no_matching_sites) | 4,484,835 | 4,487,630 |
| 实际成功数 (products中的unique source) | 4,447,334 | 3,987,440 |
| **去重导致缺失** | **37,501 (0.84%)** | **500,190 (11.15%)** |

**关键发现**: NH2组的去重删除率是OMe组的13倍！

### 4. 平均产物数差异

| 指标 | OMe组 | NH2组 | 差异 |
|------|-------|-------|------|
| 平均每个source产生的产物数 | 5.78 | 4.79 | +0.99 (+20.7%) |
| Median | 4 | 3 | +1 |
| Max | 30 | 24 | +6 |

**关键发现**: OMe组平均每个分子产生更多产物。

---

## 根本原因

### 原因1: 反应产物枚举差异 (主要原因)

**OMe反应产生更多产物**: 平均5.78个/source vs NH2的4.79个/source

可能的化学原因：
1. **worker数量不同**: OMe用8个workers，NH2用4个workers
   - 但这不应该影响产物数量，只影响速度
2. **代码版本差异**: 两次运行时间相差7小时（NH2: 08:32，OMe: 15:44）
   - 可能期间修改了代码参数
3. **RDKit枚举行为**: 可能存在非确定性或并发处理差异

**验证**: 小样本测试(1000分子)显示SMIRKS本身无差异，都产生5.52个产物/分子。说明**不是化学反应的问题，而是运行时差异**。

### 原因2: NH2组的高去重率 (次要原因)

**NH2组有11.15%的source被完全去重，OMe只有0.84%**

化学原因：
1. **Ar-NH2的化学多样性较低**:
   - 氨基(-NH2)是简单的一价取代基
   - 甲氧基(-OCH3)有更多构象自由度
2. **结构坍缩效应**:
   - 不同的输入分子经过NH2替换可能产生相同的产物
   - 例如：两个异构体的OH位置不同，但替换后结构相似度提高
3. **InChIKey去重的影响**:
   - NH2可能导致更多立体异构体转化为相同的InChIKey

---

## 两次运行的配置差异验证

| 参数 | OMe组 | NH2组 |
|------|-------|-------|
| workers | 8 | 4 |
| 运行时间 | 2025-11-12 15:44 | 2025-11-12 08:32 |
| 时间差 | - | 先运行7.2小时 |
| 代码版本 | 08_transform_library_v2.py (修改于02:46) | 同左 |

**结论**: 代码版本相同，但workers数量不同。然而workers数量不应影响产物数量，只影响速度。

---

## 最终结论

### 产物数量差异的真正原因

**34.5%的产物数量差异** 主要来自两个因素的叠加：

1. **反应枚举层面的差异 (主要，贡献~80%)**:
   - OMe组平均每个source产生5.78个产物
   - NH2组平均每个source产生4.79个产物
   - 差异原因未知，但**不是化学反应本身的问题**（小样本测试无差异）
   - **可能原因**: 运行时参数、并发处理、或代码分支逻辑的微小差异

2. **NH2组的高去重率 (次要，贡献~20%)**:
   - NH2组有50万个source的所有产物都在去重时被删除
   - 化学原因：Ar-NH2产物的化学空间多样性低于Ar-OCH3

### 建议

1. **重新运行验证**: 用完全相同的参数（8 workers）重新运行NH2组，验证差异是否消失
2. **代码审查**: 检查08_transform_library_v2.py中是否存在任何与workers数量或运行时间相关的分支逻辑
3. **详细日志**: 添加更详细的debug日志，记录每个分子产生的产物数
4. **确定性测试**: 设置random seed，确保RDKit的行为完全确定

### 对项目的影响

虽然两组产物数量相差34.5%，但这**不影响PR-A atom mapping的正确性**。两组都应该能够实现100% mapnum usage和100% high confidence的位点标记。

产物数量差异是一个**数据质量问题**，但不是**功能正确性问题**。
